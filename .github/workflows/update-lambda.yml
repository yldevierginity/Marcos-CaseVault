name: Update Lambda Functions

on:
  push:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - 'database/**'
  workflow_dispatch:

jobs:
  update-lambda:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y postgresql-client jq
      
      - name: Create Lambda packages
        run: |
          cd backend
          for func in clients cases hearings users search notifications admin_logs; do
            if [ -d "$func" ]; then
              cd "$func"
              pip install -r requirements.txt -t . --quiet
              cp ../shared/database_utils.py .
              zip -r "../${func}.zip" . -x "*.pyc" "__pycache__/*" >/dev/null
              cd ..
            fi
          done
      
      - name: Update Lambda functions
        run: |
          cd backend
          for func in clients cases hearings users search notifications admin_logs; do
            if [ -f "${func}.zip" ]; then
              FUNCTION_NAME="casevault-${func}"
              if aws lambda get-function --function-name "$FUNCTION_NAME" >/dev/null 2>&1; then
                echo "Updating Lambda function: $FUNCTION_NAME"
                aws lambda update-function-code \
                  --function-name "$FUNCTION_NAME" \
                  --zip-file "fileb://${func}.zip"
              fi
            fi
          done
      
      - name: Initialize database schema
        run: |
          DB_SECRET_ARN="${{ secrets.DB_SECRET_ARN }}"
          DB_ENDPOINT="${{ secrets.DB_ENDPOINT }}"
          
          if [ -n "$DB_SECRET_ARN" ] && [ -n "$DB_ENDPOINT" ]; then
            DB_CREDENTIALS=$(aws secretsmanager get-secret-value --secret-id "$DB_SECRET_ARN" --query SecretString --output text)
            DB_USERNAME=$(echo "$DB_CREDENTIALS" | jq -r '.username')
            DB_PASSWORD=$(echo "$DB_CREDENTIALS" | jq -r '.password')
            
            export PGPASSWORD="$DB_PASSWORD"
            if psql -h "$DB_ENDPOINT" -U "$DB_USERNAME" -d lawfirmdb -c "SELECT 1;" >/dev/null 2>&1; then
              psql -h "$DB_ENDPOINT" -U "$DB_USERNAME" -d lawfirmdb -f database/schema.sql
              echo "Database schema updated successfully!"
            fi
          fi
