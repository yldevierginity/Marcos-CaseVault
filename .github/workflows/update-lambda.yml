name: Update Lambda Functions

on:
  push:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - '!backend/requirements.txt'
  workflow_dispatch:

jobs:
  update-lambda:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Create Lambda packages
        run: |
          cd backend
          for func in clients cases hearings users search notifications admin_logs; do
            if [ -d "$func" ]; then
              cd "$func"
              pip install -r requirements.txt -t . --quiet
              cp ../shared/database_utils.py . 2>/dev/null || true
              zip -r "../${func}.zip" . -x "*.pyc" "__pycache__/*" >/dev/null
              cd ..
            fi
          done
      
      - name: Update Lambda functions
        run: |
          cd backend
          for func in clients cases hearings users search notifications admin_logs; do
            if [ -f "${func}.zip" ]; then
              FUNCTION_NAME="law-firm-${func}"
              if aws lambda get-function --function-name "$FUNCTION_NAME" >/dev/null 2>&1; then
                echo "Updating Lambda function: $FUNCTION_NAME"
                aws lambda update-function-code \
                  --function-name "$FUNCTION_NAME" \
                  --zip-file "fileb://${func}.zip"
              else
                echo "Function $FUNCTION_NAME not found, skipping..."
              fi
            fi
          done
