name: Deploy

on:
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      destroy:
        description: 'Destroy infrastructure'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.0'
          terraform_wrapper: false
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq zip
      
      - name: Bootstrap S3 backend (if needed)
        run: |
          if ! aws s3api head-bucket --bucket casevault-terraform-state 2>/dev/null; then
            ./bootstrap-terraform-state.sh
          fi
      
      - name: Create Lambda packages
        run: |
          cd backend
          for func in clients cases hearings users search notifications admin_logs; do
            if [ -d "$func" ]; then
              cd "$func"
              pip install -r requirements.txt -t . --quiet
              cp ../shared/database_utils.py .
              zip -r "../${func}.zip" . -x "*.pyc" "__pycache__/*" >/dev/null
              cd ..
            fi
          done
      
      - name: Terraform Init
        run: |
          cd infrastructure
          terraform init
      
      - name: Terraform Plan
        run: |
          cd infrastructure
          terraform plan -out=tfplan
      
      - name: Terraform Apply
        if: ${{ !inputs.destroy }}
        run: |
          cd infrastructure
          terraform apply tfplan
      
      - name: Terraform Destroy
        if: ${{ inputs.destroy }}
        run: |
          cd infrastructure
          terraform destroy -auto-approve
      
      - name: Get outputs
        if: ${{ !inputs.destroy }}
        id: outputs
        run: |
          cd infrastructure
          echo "api_endpoint=$(terraform output -raw api_gateway_url)" >> $GITHUB_OUTPUT
          echo "user_pool_id=$(terraform output -raw user_pool_id)" >> $GITHUB_OUTPUT
          echo "user_pool_client_id=$(terraform output -raw user_pool_client_id)" >> $GITHUB_OUTPUT
          echo "identity_pool_id=$(terraform output -raw identity_pool_id)" >> $GITHUB_OUTPUT
      
      - name: Build frontend
        if: ${{ !inputs.destroy }}
        run: |
          cd frontend
          cat > .env << EOF
          VITE_AWS_REGION=ap-southeast-1
          VITE_AWS_USER_POOL_ID=${{ steps.outputs.outputs.user_pool_id }}
          VITE_AWS_USER_POOL_WEB_CLIENT_ID=${{ steps.outputs.outputs.user_pool_client_id }}
          VITE_AWS_IDENTITY_POOL_ID=${{ steps.outputs.outputs.identity_pool_id }}
          VITE_AWS_API_GATEWAY_URL=${{ steps.outputs.outputs.api_endpoint }}
          EOF
          npm install
          npm run build
      
      - name: Upload build artifacts
        if: ${{ !inputs.destroy }}
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist/

  init-database:
    needs: deploy
    if: ${{ !inputs.destroy }}
    uses: ./.github/workflows/init-database.yml
