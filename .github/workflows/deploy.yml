name: Deploy

on:
  push:
    branches:
      - main
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'ap-southeast-1' }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.0'
          terraform_wrapper: false
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq zip
      
      - name: Bootstrap Terraform state backend
        run: ./bootstrap-terraform-state.sh
      
      - name: Create Lambda packages
        run: |
          cd backend
          for func in clients cases hearings users search notifications admin_logs; do
            if [ -d "$func" ]; then
              echo "Creating package for $func..."
              cd "$func"
              pip install -r requirements.txt -t . --quiet
              cp ../shared/database_utils.py . 2>/dev/null || true
              zip -r "../${func}.zip" . -x "*.pyc" "__pycache__/*" "*.git*" "*.dist-info/*" >/dev/null
              cd ..
            fi
          done
          cd ..
      
      - name: Update Lambda functions only
        run: |
          cd infrastructure
          terraform init
          
          # Get existing outputs without applying
          if terraform state list >/dev/null 2>&1; then
            echo "Infrastructure exists, updating Lambda functions only..."
            
            # Update Lambda function code
            cd ../backend
            for func in clients cases hearings users search notifications admin_logs; do
              if [ -f "${func}.zip" ]; then
                echo "Updating Lambda function: $func"
                FUNCTION_NAME=$(aws lambda list-functions --query "Functions[?contains(FunctionName, '$func')].FunctionName" --output text | head -1)
                if [ -n "$FUNCTION_NAME" ]; then
                  aws lambda update-function-code \
                    --function-name "$FUNCTION_NAME" \
                    --zip-file "fileb://${func}.zip"
                fi
              fi
            done
            cd ../infrastructure
          else
            echo "No infrastructure found, please run manual deployment first"
            exit 1
          fi
      
      - name: Get Terraform outputs
        id: tf_outputs
        run: |
          cd infrastructure
          echo "api_endpoint=$(terraform output -raw api_gateway_url)" >> $GITHUB_OUTPUT
          echo "user_pool_id=$(terraform output -raw user_pool_id)" >> $GITHUB_OUTPUT
          echo "user_pool_client_id=$(terraform output -raw user_pool_client_id)" >> $GITHUB_OUTPUT
          echo "identity_pool_id=$(terraform output -raw identity_pool_id)" >> $GITHUB_OUTPUT
          cd ..
      
      - name: Build frontend
        run: |
          cd frontend
          cat > .env << EOF
          VITE_AWS_REGION=${{ vars.AWS_REGION || 'ap-southeast-1' }}
          VITE_AWS_USER_POOL_ID=${{ steps.tf_outputs.outputs.user_pool_id }}
          VITE_AWS_USER_POOL_WEB_CLIENT_ID=${{ steps.tf_outputs.outputs.user_pool_client_id }}
          VITE_AWS_IDENTITY_POOL_ID=${{ steps.tf_outputs.outputs.identity_pool_id }}
          VITE_AWS_API_GATEWAY_URL=${{ steps.tf_outputs.outputs.api_endpoint }}
          EOF
          npm ci
          npm run build
          cd ..
