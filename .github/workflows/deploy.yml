name: Deploy

on:
  push:
    branches:
      - main
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'ap-southeast-1' }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.0'
          terraform_wrapper: false
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client jq zip
   
      - name: Bootstrap Terraform state backend
        run: ./bootstrap-terraform-state.sh

      - name: Create Lambda packages
        run: |
          cd backend
          for func in clients cases hearings users search notifications admin_logs; do
            if [ -d "$func" ]; then
              echo "Creating package for $func..."
              cd "$func"
              pip install -r requirements.txt -t . --quiet
              cp ../shared/database_utils.py . 2>/dev/null || true
              zip -r "../${func}.zip" . -x "*.pyc" "__pycache__/*" "*.git*" "*.dist-info/*" >/dev/null
              cd ..
            fi
          done
          cd ..
      
      - name: Deploy infrastructure
        run: |
          cd infrastructure
          terraform init
          terraform validate
          terraform plan -var="aws_region=${{ vars.AWS_REGION || 'ap-southeast-1' }}" -out=tfplan
          terraform apply tfplan
          cd ..
      
      - name: Get Terraform outputs
        id: tf_outputs
        run: |
          cd infrastructure
          echo "api_endpoint=$(terraform output -raw api_gateway_url)" >> $GITHUB_OUTPUT
          echo "user_pool_id=$(terraform output -raw user_pool_id)" >> $GITHUB_OUTPUT
          echo "user_pool_client_id=$(terraform output -raw user_pool_client_id)" >> $GITHUB_OUTPUT
          echo "identity_pool_id=$(terraform output -raw identity_pool_id)" >> $GITHUB_OUTPUT
          cd ..
      
      - name: Build and deploy frontend
        run: |
          cd frontend
          cat > .env << EOF
          VITE_AWS_REGION=${{ vars.AWS_REGION || 'ap-southeast-1' }}
          VITE_AWS_USER_POOL_ID=${{ steps.tf_outputs.outputs.user_pool_id }}
          VITE_AWS_USER_POOL_WEB_CLIENT_ID=${{ steps.tf_outputs.outputs.user_pool_client_id }}
          VITE_AWS_IDENTITY_POOL_ID=${{ steps.tf_outputs.outputs.identity_pool_id }}
          VITE_AWS_API_GATEWAY_URL=${{ steps.tf_outputs.outputs.api_endpoint }}
          EOF
          npm ci
          npm run build
          cd ..
