name: Initialize Database

on:
  workflow_dispatch:
  workflow_call:

jobs:
  init-database:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Create database init Lambda
        run: |
          mkdir -p temp-db-init
          cd temp-db-init
          
          cat > lambda_function.py << 'EOF'
          import json
          import psycopg2
          import boto3
          import os
          
          def lambda_handler(event, context):
              try:
                  # Get database credentials
                  secrets_client = boto3.client('secretsmanager')
                  secret_response = secrets_client.get_secret_value(
                      SecretId=os.environ['DB_SECRET_ARN']
                  )
                  secret = json.loads(secret_response['SecretString'])
                  
                  # Connect to database
                  conn = psycopg2.connect(
                      host=os.environ['CLUSTER_ENDPOINT'],
                      port=5432,
                      database='lawfirmdb',
                      user=secret['username'],
                      password=secret['password']
                  )
                  
                  cursor = conn.cursor()
                  
                  # Execute schema SQL
                  schema_sql = event.get('schema_sql', '')
                  if schema_sql:
                      cursor.execute(schema_sql)
                      conn.commit()
                  
                  cursor.close()
                  conn.close()
                  
                  return {
                      'statusCode': 200,
                      'body': json.dumps('Database schema initialized successfully')
                  }
              except Exception as e:
                  return {
                      'statusCode': 500,
                      'body': json.dumps(f'Error: {str(e)}')
                  }
          EOF
          
          cat > requirements.txt << 'EOF'
          psycopg2-binary==2.9.7
          boto3
          EOF
          
          pip install -r requirements.txt -t .
          zip -r db-init.zip . -x "*.pyc" "__pycache__/*"
      
      - name: Deploy and invoke database init Lambda
        run: |
          # Create temporary Lambda function
          aws lambda create-function \
            --function-name temp-db-init \
            --runtime python3.11 \
            --role $(aws iam list-roles --query 'Roles[?RoleName==`casevault-lambda-execution-role`].Arn' --output text) \
            --handler lambda_function.lambda_handler \
            --zip-file fileb://temp-db-init/db-init.zip \
            --vpc-config SubnetIds=$(aws ec2 describe-subnets --filters "Name=tag:Name,Values=casevault-private-*" --query 'Subnets[].SubnetId' --output text | tr '\t' ','),SecurityGroupIds=$(aws ec2 describe-security-groups --filters "Name=tag:Name,Values=casevault-lambda-sg" --query 'SecurityGroups[0].GroupId' --output text) \
            --environment Variables="{DB_SECRET_ARN=$(aws secretsmanager list-secrets --query 'SecretList[?Name==`casevault-db-credentials`].ARN' --output text),CLUSTER_ENDPOINT=$(aws rds describe-db-clusters --query 'DBClusters[?DBClusterIdentifier==`casevault-cluster`].Endpoint' --output text)}" \
            --timeout 300 || true
          
          # Wait for function to be active
          aws lambda wait function-active --function-name temp-db-init
          
          # Read schema file and invoke Lambda
          SCHEMA_SQL=$(cat database/schema.sql | jq -Rs .)
          aws lambda invoke \
            --function-name temp-db-init \
            --payload "{\"schema_sql\": $SCHEMA_SQL}" \
            response.json
          
          # Check response
          cat response.json
          if grep -q "Error" response.json; then
            echo "Database initialization failed"
            exit 1
          fi
          
          # Clean up
          aws lambda delete-function --function-name temp-db-init
          echo "Database schema initialized successfully!"
